#include <WiFi.h>
#include <WebServer.h>

// --- Definições dos pinos ---
#define TRIG 5
#define ECHO 4
#define RELE 2

// Medidas da caixa (cm)
const float COMPRIMENTO = 50.0;
const float LARGURA     = 35.0;
const float ALTURA_CAIXA = 40.0;

// Volume total (L)
const float VOLUME_TOTAL = (COMPRIMENTO * LARGURA * ALTURA_CAIXA) / 1000.0;

// Controle da bomba
bool bombaLigada = false;
bool manutencao = false;

// --- Configuração WiFi ---
const char* ssid = "xxxxxxxxx";
const char* pass = "xxxxxxxx";

WebServer server(80);
float percentual = 0.0;

// --- Função de medição ---
void medirCaixa() {
  digitalWrite(TRIG, LOW);
  delayMicroseconds(2);
  digitalWrite(TRIG, HIGH);
  delayMicroseconds(10);
  digitalWrite(TRIG, LOW);

  long duracao = pulseIn(ECHO, HIGH);
  float distancia = duracao * 0.0343 / 2;

  float alturaAgua = ALTURA_CAIXA - distancia;
  if (alturaAgua < 0) alturaAgua = 0;
  if (alturaAgua > ALTURA_CAIXA) alturaAgua = ALTURA_CAIXA;

  float volume = (COMPRIMENTO * LARGURA * alturaAgua) / 1000.0;
  percentual = (volume / VOLUME_TOTAL) * 100.0;

  // --- Lógica automática ---
  if (!manutencao) {
    if (percentual <= 15.0) {
      bombaLigada = true;
    } else if (percentual >= 90.0) {
      bombaLigada = false;
    }
  } else {
    // Se manutenção está ativa, desliga a bomba SEMPRE
    bombaLigada = false;
  }

  // --- Controle do relé ---
  if (bombaLigada) {
    digitalWrite(RELE, LOW);   // Liga bomba
  } else {
    digitalWrite(RELE, HIGH);  // Desliga bomba
  }
}

// --- Página HTML estilizada ---
String getHTML() {
  String html = "<!DOCTYPE html><html><head><meta charset='UTF-8'>";
  html += "<meta name='viewport' content='width=device-width, initial-scale=1.0'>";
  html += "<meta http-equiv='refresh' content='5'>";
  html += "<title>Caixa d'Água</title>";
  html += "<style>";
  html += "body { font-family: Arial, sans-serif; background: #f4f7f9; text-align: center; margin: 0; padding: 0; }";
  html += "h1 { background: #0077cc; color: white; padding: 20px; margin: 0; }";
  html += "p { font-size: 1.2em; margin: 10px 0; }";
  html += ".status { margin: 20px auto; width: 80%; max-width: 400px; }";
  html += ".progress { background: #ddd; border-radius: 20px; overflow: hidden; height: 30px; margin-top: 10px; }";
  html += ".progress-bar { height: 100%; text-align: center; color: white; line-height: 30px; font-weight: bold; }";
  html += ".on { background: #28a745; }";
  html += ".off { background: #dc3545; }";
  html += ".btn { display: inline-block; margin: 10px; padding: 12px 25px; font-size: 16px; border: none; border-radius: 8px; cursor: pointer; text-decoration: none; color: white; transition: 0.3s; }";
  html += ".btn:hover { opacity: 0.85; }";
  html += ".btn-green { background: #28a745; }";
  html += ".btn-red { background: #dc3545; }";
  html += ".btn-blue { background: #0077cc; }";
  html += "</style></head><body>";

  html += "<h1>Monitoramento da Caixa d'Água</h1>";

  html += "<div class='status'>";
  html += "<p><b>Nível:</b> " + String(percentual, 1) + "%</p>";
  html += "<div class='progress'><div class='progress-bar " + String(percentual > 20 ? "on" : "off") + "' style='width:" + String(percentual) + "%'>" + String(percentual, 1) + "%</div></div>";
  html += "<p><b>Bomba:</b> <span style='color:" + String(bombaLigada ? "green" : "red") + "; font-weight:bold;'>" + String(bombaLigada ? "LIGADA" : "DESLIGADA") + "</span></p>";
  html += "<p><b>Modo Manutenção:</b> " + String(manutencao ? "ATIVO" : "DESATIVADO") + "</p>";
  html += "</div>";

  html += "<div>";
  html += "<a href='/liga' class='btn btn-green'>Ligar Bomba</a>";
  html += "<a href='/desliga' class='btn btn-red'>Desligar Bomba</a>";
  html += "<a href='/manutencao' class='btn btn-blue'>Alternar Manutenção</a>";
  html += "</div>";

  html += "</body></html>";
  return html;
}

// --- Rotas ---
void handleRoot() {
  medirCaixa();
  server.send(200, "text/html", getHTML());
}

void handleLiga() {
  if (percentual < 50.0) {
    bombaLigada = true;
  }
  server.sendHeader("Location", "/");
  server.send(303);
}

void handleDesliga() {
  if (percentual > 50.0) {
    bombaLigada = false;
  }
  server.sendHeader("Location", "/");
  server.send(303);
}

void handleManutencao() {
  manutencao = !manutencao;
  server.sendHeader("Location", "/");
  server.send(303);
}

void setup() {
  Serial.begin(115200);
  pinMode(TRIG, OUTPUT);
  pinMode(ECHO, INPUT);
  pinMode(RELE, OUTPUT);
  digitalWrite(RELE, HIGH);

  WiFi.begin(ssid, pass);
  Serial.print("Conectando ao WiFi...");
  while (WiFi.status() != WL_CONNECTED) {
    delay(1000);
    Serial.print(".");
  }
  Serial.println("\nWiFi conectado!");
  Serial.print("IP: ");
  Serial.println(WiFi.localIP());

  server.on("/", handleRoot);
  server.on("/liga", handleLiga);
  server.on("/desliga", handleDesliga);
  server.on("/manutencao", handleManutencao);
  server.begin();
}

void loop() {
  server.handleClient();
}
